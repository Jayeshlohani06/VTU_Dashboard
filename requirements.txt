dash==2.11.0
dash-bootstrap-components==1.4.1
pandas==2.2.2
plotly==5.15.0
numpy==1.26.2
gunicorn==20.1.0
openpyxl==3.1.2
# import dash
# from dash import html, dcc, Input, Output, callback
# import dash_bootstrap_components as dbc
# import pandas as pd
# from io import StringIO

# import utils.master_store as ms


# dash.register_page(__name__, path="/branch-intelligence", name="Branch Intelligence")


# # ---------------- Ranking Logic Import ----------------

# def normalize_for_branch(df_long):
#     """
#     Convert long subject rows â†’ wide student rows
#     then apply ranking-style normalization with VTU pass/fail logic
#     """

#     if df_long.empty:
#         return df_long

#     # Pivot long â†’ wide
#     df_wide = df_long.pivot_table(
#         index=["Student_ID", "Name", "Branch"],
#         columns="Subject",
#         values="Result",
#         aggfunc="first"
#     ).reset_index()

#     # Get subject Result columns
#     subject_cols = [c for c in df_wide.columns if c not in ["Student_ID", "Name", "Branch"]]

#     # Apply same pass/fail logic as ranking page:
#     # Student passes only if ALL subjects show 'P' result
#     # OR if Result columns exist, trust them as the authority
#     df_wide["Overall_Result"] = df_wide[subject_cols].apply(
#         lambda row: "P" if all(str(v).strip().upper() == "P" for v in row if pd.notna(v)) else "F",
#         axis=1
#     )

#     return df_wide


# # ---------------- Layout ----------------

# layout = dbc.Container([

#     html.Br(),
#     html.H2("ðŸ§  Branch Intelligence Dashboard", className="text-center"),

#     html.P(
#         "Advanced analytics across branches, subjects and student performance.",
#         className="text-center text-muted"
#     ),

#     html.Hr(),

#     dbc.Row([

#         dbc.Col(dbc.Card(dbc.CardBody([
#             html.H6("Total Students"),
#             html.H3(id="bi-total-students")
#         ]), className="shadow-sm text-center"), md=3),

#         dbc.Col(dbc.Card(dbc.CardBody([
#             html.H6("Branches Loaded"),
#             html.H3(id="bi-total-branches")
#         ]), className="shadow-sm text-center"), md=3),

#         dbc.Col(dbc.Card(dbc.CardBody([
#             html.H6("Subjects Detected"),
#             html.H3(id="bi-total-subjects")
#         ]), className="shadow-sm text-center"), md=3),

#         dbc.Col(dbc.Card(dbc.CardBody([
#             html.H6("Overall Pass %"),
#             html.H3(id="bi-pass-percent")
#         ]), className="shadow-sm text-center"), md=3),

#     ], className="mb-4"),

#     dbc.Card([
#         dbc.CardBody([
#             html.H4("ðŸ“Š Branch Performance Comparison"),

#             dbc.Row([
#                 dbc.Col(dcc.Dropdown(id="bi-branch-selector", placeholder="Select branch"), md=6),
#                 dbc.Col(dcc.Dropdown(id="bi-subject-selector", placeholder="Select subject"), md=6),
#             ], className="mb-3"),

#             html.Div(id="bi-branch-table")
#         ])
#     ], className="shadow-sm mb-4"),

#     dbc.Card([
#         dbc.CardBody([
#             html.H4("ðŸ“š Subject Overview"),
#             html.Div(id="bi-subject-summary")
#         ])
#     ], className="shadow-sm mb-4")

# ], fluid=True)


# # ---------------- KPI LOAD ----------------

# @callback(
#     Output("bi-total-students", "children"),
#     Output("bi-total-branches", "children"),
#     Output("bi-total-subjects", "children"),
#     Output("bi-pass-percent", "children"),
#     Output("bi-branch-selector", "options"),
#     Output("bi-subject-selector", "options"),
#     Input("bi-branch-selector", "value")
# )
# def load_branch_intelligence(_):

#     if ms.MASTER_BRANCH_DATA is None:
#         return "-", "-", "-", "-", [], []

#     df = ms.MASTER_BRANCH_DATA

#     df_students = normalize_for_branch(df)

#     total_students = df_students["Student_ID"].nunique()
#     total_branches = df_students["Branch"].nunique()
#     total_subjects = df["Subject"].nunique()

#     pass_percent = round(
#         (df_students[df_students["Overall_Result"] == "P"].shape[0] /
#          df_students.shape[0]) * 100, 2
#     )

#     branch_options = [{"label": b, "value": b} for b in sorted(df["Branch"].unique())]
#     subject_options = [{"label": s, "value": s} for s in sorted(df["Subject"].unique())]

#     return total_students, total_branches, total_subjects, f"{pass_percent}%", branch_options, subject_options


# # ---------------- BRANCH TABLE ----------------

# @callback(
#     Output("bi-branch-table", "children"),
#     Input("bi-branch-selector", "value"),
#     Input("bi-subject-selector", "value")
# )
# def generate_branch_table(selected_branch, selected_subject):

#     if ms.MASTER_BRANCH_DATA is None:
#         return dbc.Alert("Upload branch files first.", color="warning")

#     df = ms.MASTER_BRANCH_DATA

#     if selected_branch:
#         df = df[df["Branch"] == selected_branch]

#     if selected_subject:
#         df = df[df["Subject"] == selected_subject]

#     summary = df.groupby("Branch").agg(
#         Students=("Student_ID", "nunique"),
#         Passed=("Result", lambda x: (x == "P").sum()),
#         Failed=("Result", lambda x: (x == "F").sum())
#     ).reset_index()

#     return dbc.Table.from_dataframe(summary, bordered=True, striped=True, hover=True)


# # ---------------- SUBJECT SUMMARY ----------------

# @callback(
#     Output("bi-subject-summary", "children"),
#     Input("bi-branch-selector", "value")
# )
# def subject_summary(selected_branch):

#     if ms.MASTER_BRANCH_DATA is None:
#         return ""

#     df = ms.MASTER_BRANCH_DATA

#     if selected_branch:
#         df = df[df["Branch"] == selected_branch]

#     subject_stats = df.groupby("Subject").agg(
#         Students=("Student_ID", "nunique"),
#         Pass=("Result", lambda x: (x == "P").sum()),
#         Fail=("Result", lambda x: (x == "F").sum())
#     ).reset_index()

#     return dbc.Table.from_dataframe(subject_stats, bordered=True, striped=True, hover=True)
